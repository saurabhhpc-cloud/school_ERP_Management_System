{% extends "school/base_school.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<!-- KPI ROW -->
<div class="row g-4 mb-4">

  <div class="col-md-3">
    <div class="card stat-card bg-primary">
      <small>Total Students</small>
      <h3>{{ total_students }}</h3>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card bg-info">
      <small>Total Teachers</small>
      <h3>{{ total_teachers }}</h3>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card bg-success">
      <small>Fees Collected</small>
      <h3>₹ {{ fees_collected|floatformat:0 }}</h3>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card bg-warning">
      <small>Pending Fees</small>
      <h3>₹ {{ pending_fees_amount|floatformat:0 }}</h3>
    </div>
  </div>

</div>

<!-- MINI CHARTS -->
<div class="row g-4 mb-4">

  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-body">
        <h6 class="small mb-3">Class Result</h6>
        <div class="chart-container">
          <canvas id="resultChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-body">
        <h6 class="small mb-3">Attendance Today</h6>
        <div class="chart-container">
          <canvas id="attendancePie"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card chart-card h-100">
      <div class="card-body">
        <h6 class="small mb-3">Monthly Revenue</h6>
        <div class="chart-container">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

</div>


<!-- HEATMAP -->
<div class="card p-4 mb-4">
  <h6>Attendance Heatmap</h6>
  <div class="row">
    {% for d in heatmap_data %}
    <div class="col-2 mb-2">
      <div class="p-2 text-center rounded text-white"
           style="background-color: rgba(34,197,94, {{ d.opacity }});">
        {{ d.percentage }}%
        <div class="small">{{ d.date }}</div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-muted text-center">
      No attendance data
    </div>
    {% endfor %}
  </div>
</div>

<!-- FORECAST -->
<div class="card p-4 mb-4">
  <h6>Revenue Forecast</h6>
  <h5>Next Month Estimate: ₹ {{ forecast_revenue }}</h5>
</div>

{% if drop_alert %}
<div class="alert alert-danger">
  Revenue dropped compared to last month!
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>

document.addEventListener("DOMContentLoaded", function(){

/* ================= RESULT BAR ================= */
new Chart(document.getElementById("resultChart"), {
  type: "bar",
  data: {
    labels: {{ result_labels|safe }},
    datasets: [{
      data: {{ result_data|safe }},
      backgroundColor: "#6366f1"
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false
  }
});


/* ================= ATTENDANCE PIE ================= */
new Chart(document.getElementById("attendancePie"), {
  type: "doughnut",
  data: {
    labels:["Present","Absent"],
    datasets:[{
      data:[
        {{ today_present|default:0 }},
        {{ today_absent|default:0 }}
      ],
      backgroundColor:["#22c55e","#ef4444"]
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    cutout:"65%"
  }
});


/* ================= MONTHLY REVENUE ================= */
new Chart(document.getElementById("monthlyChart"), {
  type:"line",
  data:{
    labels: {{ monthly_labels|safe }},
    datasets:[{
      data: {{ monthly_data|safe }},
      borderColor:"#22c55e",
      fill:true,
      backgroundColor:"rgba(34,197,94,.2)",
      tension:.4
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false
  }
});

});

</script>
{% endblock %}
