{% extends "school/base_school.html" %}
{% block title %}Students List{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- ================= HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold mb-0">
            <i class="bi bi-people-fill text-primary"></i> Students
        </h4>

        <div class="d-flex gap-2">
            <a href="{% url 'students:import_students' %}" class="btn btn-success">
                <i class="bi bi-upload"></i> Import
            </a>

            <a href="{% url 'students:add_student' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Student
            </a>
        </div>
    </div>

    <!-- ================= FILTER ================= -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">

                {% csrf_token %}

                <div class="col-md-3">
                    <select name="class" class="form-select">
                        <option value="">All Classes</option>
                        {% for cls in classes %}
                        <option value="{{ cls }}" {% if request.GET.class == cls %}selected{% endif %}>
                            {{ cls }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <select name="section" class="form-select">
                        <option value="">All Sections</option>
                        {% for sec in sections %}
                        <option value="{{ sec }}" {% if request.GET.section == sec %}selected{% endif %}>
                            {{ sec }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <input type="text"
                           name="search"
                           value="{{ request.GET.search }}"
                           class="form-control"
                           placeholder="Search by name">
                </div>

                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>

            </form>
        </div>
    </div>

    <!-- ================= TABLE ================= -->
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="table-responsive">

                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Section</th>
                            <th>Roll No</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% for student in students %}
                        <tr>
                            <td>{{ forloop.counter }}</td>

                            <td>
                                <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                            </td>

                            <td>{{ student.admission.class_applied }}</td>
                            <td>{{ student.admission.section }}</td>
                            <td>{{ student.roll_number }}</td>

                            <td>
                                <span class="badge {% if student.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ student.is_active|yesno:"Active,Inactive" }}
                                </span>
                            </td>

                            <td>
                                <!-- EDIT -->
                                <button 
                                    class="btn btn-sm btn-warning"
                                    data-bs-toggle="modal"
                                    data-bs-target="#editModal{{ student.id }}">
                                    <i class="bi bi-pencil-square"></i>
                                </button>

                                <!-- AJAX TOGGLE -->
                                <button 
                                    class="btn btn-sm btn-outline-dark ms-1 toggle-btn"
                                    data-id="{{ student.id }}">
                                    Toggle
                                </button>
                            </td>
                        </tr>

                        <!-- ================= EDIT MODAL ================= -->
                        <div class="modal fade" id="editModal{{ student.id }}" tabindex="-1">
                          <div class="modal-dialog modal-lg">
                            <div class="modal-content">

                              <form method="POST" 
                                    class="edit-form"
                                    data-id="{{ student.id  }}"
                                {% csrf_token %}

                                <div class="modal-header bg-primary text-white">
                                  <h5 class="modal-title">
                                    Edit Student - {{ student.first_name }}
                                  </h5>
                                  <button type="button"
                                          class="btn-close btn-close-white"
                                          data-bs-dismiss="modal"></button>
                                </div>

                                <div class="modal-body row g-3">

                                    <div class="col-md-6">
                                        <label>Father Name</label>
                                        <input type="text" name="father_name"
                                               class="form-control"
                                               value="{{ student.parent.father_name }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Mother Name</label>
                                        <input type="text" name="mother_name"
                                               class="form-control"
                                               value="{{ student.parent.mother_name }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Mobile</label>
                                        <input type="text" name="primary_mobile"
                                               class="form-control"
                                               value="{{ student.parent.primary_mobile }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Email</label>
                                        <input type="email" name="email"
                                               class="form-control"
                                               value="{{ student.parent.email }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>First Name</label>
                                        <input type="text" name="first_name"
                                               class="form-control"
                                               value="{{ student.first_name }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Last Name</label>
                                        <input type="text" name="last_name"
                                               class="form-control"
                                               value="{{ student.last_name }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Class</label>
                                        <input type="text" name="class_applied"
                                               class="form-control"
                                               value="{{ student.admission.class_applied }}">
                                    </div>

                                    <div class="col-md-6">
                                        <label>Section</label>
                                        <input type="text" name="section"
                                               class="form-control"
                                               value="{{ student.admission.section }}">
                                    </div>

                                </div>

                                <div class="modal-footer">
                                  <button type="button"
                                          class="btn btn-secondary"
                                          data-bs-dismiss="modal">
                                          Cancel
                                  </button>

                                  <button type="submit"
                                          class="btn btn-primary">
                                          Update Student
                                  </button>
                                </div>

                              </form>

                            </div>
                          </div>
                        </div>

                    {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No students found
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>

                </table>

            </div>
        </div>
    </div>

</div>

<!-- ================= AJAX SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    document.querySelectorAll(".toggle-btn").forEach(function(button){

        button.addEventListener("click", function(){

            let studentId = this.dataset.id
            let row = this.closest("tr")
            let statusBadge = row.querySelector(".badge")

            fetch(`/students/toggle-status/${studentId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {

                if(data.success){

                    if(data.is_active){
                        statusBadge.classList.remove("bg-secondary")
                        statusBadge.classList.add("bg-success")
                        statusBadge.textContent = "Active"
                    } else {
                        statusBadge.classList.remove("bg-success")
                        statusBadge.classList.add("bg-secondary")
                        statusBadge.textContent = "Inactive"
                    }

                }

            });

        });

    });

});
</script>

<script>

document.querySelectorAll(".edit-form").forEach(function(form){

    form.addEventListener("submit", function(e){

        e.preventDefault()

        let studentId = this.dataset.id
        let formData = new FormData(this)
        let row = document.querySelector(`button[data-id="${studentId}"]`).closest("tr")

        fetch(`/students/edit/${studentId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {

            if(data.success){

                row.cells[1].innerHTML = "<strong>" + data.first_name + " " + data.last_name + "</strong>"
                row.cells[2].innerText = data.class
                row.cells[3].innerText = data.section

                bootstrap.Modal.getInstance(
                    document.getElementById("editModal" + studentId)
                ).hide()

            }

        })

    })

})

</script>

{% endblock %}
